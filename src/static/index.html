<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedGemma Clinical Decision Support</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
                    <circle cx="20" cy="20" r="18" stroke="currentColor" stroke-width="2"/>
                    <path d="M20 10v20M10 20h20" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                </svg>
                <h1>MedGemma CDS</h1>
            </div>
            <p class="subtitle">Clinical Decision Support powered by GraphRAG</p>
        </header>

        <main>
            <div class="query-section">
                <label for="query-input">Ask a clinical question:</label>
                <div class="input-group">
                    <textarea id="query-input" placeholder="e.g., What medications is the patient taking? What are the potential drug interactions?"></textarea>
                    <button id="submit-btn" onclick="submitQuery()">
                        <span class="btn-text">Ask</span>
                        <span class="btn-loading" style="display:none;">
                            <svg class="spinner" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="31.4 31.4"/>
                            </svg>
                        </span>
                    </button>
                </div>
            </div>

            <div id="response-section" class="response-section" style="display:none;">
                <div class="response-card">
                    <h2>Response</h2>
                    <div id="answer" class="answer"></div>
                </div>
                <div class="sources-card">
                    <h3>Sources</h3>
                    <ul id="sources"></ul>
                </div>
            </div>

            <div id="error-section" class="error-section" style="display:none;">
                <p id="error-message"></p>
            </div>
        </main>

        <footer>
            <p>⚠️ For educational purposes only. Not for clinical use.</p>
        </footer>
    </div>

    <script>
        async function submitQuery() {
            const input = document.getElementById('query-input');
            const question = input.value.trim();
            if (!question) return;

            const btn = document.getElementById('submit-btn');
            const btnText = btn.querySelector('.btn-text');
            const btnLoading = btn.querySelector('.btn-loading');
            const responseSection = document.getElementById('response-section');
            const errorSection = document.getElementById('error-section');

            // Show loading
            btn.disabled = true;
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline-block';
            responseSection.style.display = 'none';
            errorSection.style.display = 'none';

            try {
                const response = await fetch('/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question })
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                const data = await response.json();
                
                document.getElementById('answer').innerHTML = formatAnswer(data.answer);
                
                const sourcesList = document.getElementById('sources');
                sourcesList.innerHTML = data.sources.map(s => `<li>${s}</li>`).join('');
                
                responseSection.style.display = 'block';
            } catch (error) {
                document.getElementById('error-message').textContent = `Error: ${error.message}`;
                errorSection.style.display = 'block';
            } finally {
                btn.disabled = false;
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
            }
        }

        function formatAnswer(text) {
            return text.replace(/\n/g, '<br>');
        }

        // Submit on Enter (Shift+Enter for newline)
        document.getElementById('query-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                submitQuery();
            }
        });
    </script>
</body>
</html>
